<template>
  <div class="min-h-screen bg-gray-50">
    <!-- í—¤ë” -->
    <div class="bg-white shadow-sm border-b">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="text-sm text-gray-600">YCS LMS ì‹œìŠ¤í…œ ê´€ë¦¬ ë° ëª¨ë‹ˆí„°ë§</p>
          </div>
          <div class="flex items-center space-x-4">
            <div class="text-right">
              <div class="text-sm font-medium text-gray-900">ê´€ë¦¬ì</div>
              <div class="text-xs text-gray-500">{{ currentTime }}</div>
            </div>
            <div class="h-8 w-8 bg-blue-500 rounded-full flex items-center justify-center">
              <span class="text-white font-medium text-sm">ê´€</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6 space-y-6">
      <!-- í•µì‹¬ ì§€í‘œ -->
      <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- ì „ì²´ ì£¼ë¬¸ -->
        <div class="bg-white overflow-hidden shadow-sm rounded-lg">
          <div class="p-5">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                  <span class="text-2xl">ğŸ“¦</span>
                </div>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">ì „ì²´ ì£¼ë¬¸</dt>
                  <dd class="text-2xl font-bold text-gray-900">{{ stats.totalOrders }}</dd>
                </dl>
              </div>
            </div>
          </div>
          <div class="bg-blue-50 px-5 py-3">
            <div class="text-sm">
              <span class="text-blue-600 font-medium">+{{ stats.todayOrders }}</span>
              <span class="text-gray-600"> ì˜¤ëŠ˜ ìƒˆ ì£¼ë¬¸</span>
            </div>
          </div>
        </div>

        <!-- ì°½ê³  í˜„í™© -->
        <div class="bg-white overflow-hidden shadow-sm rounded-lg">
          <div class="p-5">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                  <span class="text-2xl">ğŸ­</span>
                </div>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">ì°½ê³  ë³´ê´€</dt>
                  <dd class="text-2xl font-bold text-gray-900">{{ warehouse.totalInWarehouse }}</dd>
                </dl>
              </div>
            </div>
          </div>
          <div class="bg-green-50 px-5 py-3">
            <div class="text-sm">
              <span class="text-green-600 font-medium">{{ warehouse.arrivedCount }}</span>
              <span class="text-gray-600"> ì…ê³  ì™„ë£Œ</span>
            </div>
          </div>
        </div>

        <!-- ë¹„ì¦ˆë‹ˆìŠ¤ ë£° ì ìš© -->
        <div class="bg-white overflow-hidden shadow-sm rounded-lg">
          <div class="p-5">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                  <span class="text-2xl">âš ï¸</span>
                </div>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">íŠ¹ìˆ˜ ì²˜ë¦¬</dt>
                  <dd class="text-2xl font-bold text-gray-900">{{ stats.specialCases }}</dd>
                </dl>
              </div>
            </div>
          </div>
          <div class="bg-yellow-50 px-5 py-3">
            <div class="text-sm text-gray-600">
              CBMì´ˆê³¼/THBì´ˆê³¼/ì½”ë“œì—†ìŒ
            </div>
          </div>
        </div>

        <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
        <div class="bg-white overflow-hidden shadow-sm rounded-lg">
          <div class="p-5">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                  <span class="text-2xl">âœ…</span>
                </div>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">ì‹œìŠ¤í…œ ìƒíƒœ</dt>
                  <dd class="text-lg font-medium text-green-600">ì •ìƒ</dd>
                </dl>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-5 py-3">
            <div class="text-sm text-gray-600">
              ìµœê·¼ ì—…ë°ì´íŠ¸: {{ currentTime }}
            </div>
          </div>
        </div>
      </div>

      <!-- ë¹ ë¥¸ ì‘ì—… -->
      <div class="bg-white rounded-lg shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">ë¹ ë¥¸ ì‘ì—…</h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <button 
              @click="navigateToOrders" 
              class="group relative bg-white p-6 focus-within:ring-2 focus-within:ring-inset focus-within:ring-green-500 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-green-50"
            >
              <div>
                <span class="rounded-lg inline-flex p-3 bg-green-50 text-green-700 ring-4 ring-white text-2xl">
                  ğŸ“¦
                </span>
              </div>
              <div class="mt-4">
                <h3 class="text-lg font-medium text-gray-900">
                  ì£¼ë¬¸ ê´€ë¦¬
                </h3>
                <p class="mt-2 text-sm text-gray-500">
                  ì£¼ë¬¸ ì¡°íšŒ ë° ìƒíƒœ ê´€ë¦¬
                </p>
              </div>
            </button>

            <button 
              @click="navigateToWarehouse" 
              class="group relative bg-white p-6 focus-within:ring-2 focus-within:ring-inset focus-within:ring-purple-500 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-purple-50"
            >
              <div>
                <span class="rounded-lg inline-flex p-3 bg-purple-50 text-purple-700 ring-4 ring-white text-2xl">
                  ğŸ­
                </span>
              </div>
              <div class="mt-4">
                <h3 class="text-lg font-medium text-gray-900">
                  ì°½ê³  ê´€ë¦¬
                </h3>
                <p class="mt-2 text-sm text-gray-500">
                  ì°½ê³  í˜„í™© ë° ìŠ¤ìº” ê´€ë¦¬
                </p>
              </div>
            </button>

            <button 
              @click="navigateToUserApproval" 
              class="group relative bg-white p-6 focus-within:ring-2 focus-within:ring-inset focus-within:ring-yellow-500 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-yellow-50"
            >
              <div>
                <span class="rounded-lg inline-flex p-3 bg-yellow-50 text-yellow-700 ring-4 ring-white text-2xl">
                  ğŸ‘¥
                </span>
              </div>
              <div class="mt-4">
                <h3 class="text-lg font-medium text-gray-900">
                  ì‚¬ìš©ì ìŠ¹ì¸
                </h3>
                <p class="mt-2 text-sm text-gray-500">
                  ê¸°ì—…/íŒŒíŠ¸ë„ˆ ìŠ¹ì¸ ì²˜ë¦¬
                </p>
              </div>
            </button>

            <button 
              @click="navigateToReports" 
              class="group relative bg-white p-6 focus-within:ring-2 focus-within:ring-inset focus-within:ring-orange-500 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-orange-50"
            >
              <div>
                <span class="rounded-lg inline-flex p-3 bg-orange-50 text-orange-700 ring-4 ring-white text-2xl">
                  ğŸ“Š
                </span>
              </div>
              <div class="mt-4">
                <h3 class="text-lg font-medium text-gray-900">
                  ë¦¬í¬íŠ¸
                </h3>
                <p class="mt-2 text-sm text-gray-500">
                  í†µê³„ ë° ë¶„ì„ ë¦¬í¬íŠ¸
                </p>
              </div>
            </button>
          </div>
        </div>
      </div>

      <!-- ìµœê·¼ í™œë™ -->
      <div class="bg-white rounded-lg shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">ìµœê·¼ í™œë™</h2>
        </div>
        <div class="p-6">
          <div v-if="loading" class="space-y-4">
            <div v-for="i in 5" :key="i" class="animate-pulse flex space-x-4">
              <div class="rounded-full bg-gray-200 h-10 w-10"></div>
              <div class="flex-1 space-y-2 py-1">
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                <div class="h-3 bg-gray-200 rounded w-1/2"></div>
              </div>
            </div>
          </div>
          <div v-else class="flow-root">
            <ul class="-mb-8">
              <li v-for="(activity, index) in recentActivity" :key="activity.id">
                <div class="relative pb-8">
                  <div v-if="index !== recentActivity.length - 1" class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200"></div>
                  <div class="relative flex space-x-3">
                    <div>
                      <span :class="[
                        'h-8 w-8 rounded-full flex items-center justify-center ring-8 ring-white text-xl',
                        getActivityIconClass(activity.type)
                      ]">
                        {{ getActivityIcon(activity.type) }}
                      </span>
                    </div>
                    <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                      <div>
                        <p class="text-sm text-gray-500">{{ getKoreanDescription(activity) }}</p>
                      </div>
                      <div class="text-right text-sm whitespace-nowrap text-gray-500">
                        {{ formatTimeKorean(activity.timestamp) }}
                      </div>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { adminApi } from '@/utils/api'

const router = useRouter()
const loading = ref(true)

const stats = ref({
  totalOrders: 0,
  todayOrders: 0,
  specialCases: 0
})

const warehouse = ref({
  totalInWarehouse: 0,
  arrivedCount: 0
})

const currentTime = ref(new Date().toLocaleString('ko-KR'))

interface Activity {
  id: number
  type: 'user_registered' | 'order_created' | 'user_approved' | 'scan_event' | 'status_changed'
  description: string
  timestamp: Date
}

const recentActivity = ref<Activity[]>([])

const getActivityIconClass = (type: string) => {
  const classes = {
    'user_registered': 'bg-blue-500',
    'order_created': 'bg-green-500', 
    'user_approved': 'bg-purple-500',
    'scan_event': 'bg-orange-500',
    'status_changed': 'bg-indigo-500'
  }
  return classes[type as keyof typeof classes] || 'bg-gray-500'
}

const getActivityIcon = (type: string) => {
  const icons = {
    'user_registered': 'ğŸ‘¥',
    'order_created': 'ğŸ“¦',
    'user_approved': 'âœ…',
    'scan_event': 'ğŸ“±',
    'status_changed': 'âš™ï¸'
  }
  return icons[type as keyof typeof icons] || 'ğŸ“'
}

const getKoreanDescription = (activity: Activity) => {
  const typeMap = {
    'user_registered': 'ìƒˆ ì‚¬ìš©ì ë“±ë¡',
    'order_created': 'ìƒˆ ì£¼ë¬¸ ìƒì„±',
    'user_approved': 'ì‚¬ìš©ì ìŠ¹ì¸ ì™„ë£Œ',
    'scan_event': 'ì°½ê³  ìŠ¤ìº” ì´ë²¤íŠ¸',
    'status_changed': 'ì£¼ë¬¸ ìƒíƒœ ë³€ê²½'
  }
  return activity.description || typeMap[activity.type as keyof typeof typeMap] || activity.type
}

const formatTimeKorean = (date: Date) => {
  const now = new Date()
  const diff = now.getTime() - date.getTime()
  const minutes = Math.floor(diff / 60000)
  const hours = Math.floor(minutes / 60)
  const days = Math.floor(hours / 24)

  if (minutes < 1) return 'ë°©ê¸ˆ ì „'
  if (minutes < 60) return `${minutes}ë¶„ ì „`
  if (hours < 24) return `${hours}ì‹œê°„ ì „`
  if (days < 7) return `${days}ì¼ ì „`
  
  return date.toLocaleDateString('ko-KR', {
    month: 'long',
    day: 'numeric'
  })
}

const loadDashboardData = async () => {
  loading.value = true
  try {
    // í†µê³„ API í˜¸ì¶œ - ì˜¬ë°”ë¥¸ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
    const statsResponse = await adminApi.getSystemStats()
    
    if (statsResponse.success && statsResponse.data) {
      // ë°±ì—”ë“œ í†µê³„ ë°ì´í„° ì§ì ‘ ì‚¬ìš©
      const statsData = statsResponse.data
      stats.value.totalOrders = statsData.totalOrders || 0
      stats.value.todayOrders = statsData.todayOrders || 0
      stats.value.specialCases = statsData.specialCases || 0
      
      // ì°½ê³  í†µê³„ (ë°±ì—”ë“œì—ì„œ ì œê³µë˜ë©´ ì‚¬ìš©, ì•„ë‹ˆë©´ 0ìœ¼ë¡œ ì„¤ì •)
      warehouse.value.totalInWarehouse = statsData.totalInWarehouse || 0
      warehouse.value.arrivedCount = statsData.arrivedCount || 0
    } else {
      console.log('í†µê³„ API ì‹¤íŒ¨, ëª© ë°ì´í„° ì‚¬ìš©')
    }
    
    // ìµœê·¼ ì£¼ë¬¸ ì¡°íšŒ (ë³„ë„ë¡œ)
    const ordersResponse = await adminApi.getAllOrders({ page: 1, pageSize: 5 })
    if (ordersResponse.success && ordersResponse.data) {
      const orders = Array.isArray(ordersResponse.data) ? ordersResponse.data : 
                    (ordersResponse.data.content || [])
      
      // ìµœê·¼ í™œë™ ìƒì„± (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)
      recentActivity.value = orders.slice(0, 5).map((order: any, index: number) => ({
        id: order.id,
        type: 'order_created' as const,
        description: `ìƒˆ ì£¼ë¬¸ ${order.orderNumber}ì´(ê°€) ${order.user?.name || order.recipientName}ë‹˜ì— ì˜í•´ ìƒì„±ë¨`,
        timestamp: new Date(order.createdAt)
      }))
      
    } else {
      // ëª© ë°ì´í„° í´ë°±
      stats.value = {
        totalOrders: 19,
        todayOrders: 3,
        specialCases: 8
      }
      
      warehouse.value = {
        totalInWarehouse: 12,
        arrivedCount: 8
      }
      
      recentActivity.value = [
        {
          id: 1,
          type: 'order_created',
          description: 'ìƒˆ ì£¼ë¬¸ YCS-250824-012ì´(ê°€) í…ŒìŠ¤íŠ¸ ìˆ˜ì·¨ì¸ë‹˜ì— ì˜í•´ ìƒì„±ë¨',
          timestamp: new Date(Date.now() - 300000) // 5ë¶„ ì „
        },
        {
          id: 2,
          type: 'user_registered',
          description: 'ì‚¼ì„±ì „ìê°€ ê¸°ì—… ì‚¬ìš©ìë¡œ ë“±ë¡ë¨',
          timestamp: new Date(Date.now() - 600000) // 10ë¶„ ì „
        },
        {
          id: 3,
          type: 'scan_event',
          description: 'ì°½ê³ ì—ì„œ ì…ê³  ìŠ¤ìº” ì´ë²¤íŠ¸ ë°œìƒ',
          timestamp: new Date(Date.now() - 3600000) // 1ì‹œê°„ ì „
        },
        {
          id: 4,
          type: 'status_changed',
          description: 'ì£¼ë¬¸ YCS-250824-011 ìƒíƒœê°€ ë°°ì†¡ì¤‘ìœ¼ë¡œ ë³€ê²½ë¨',
          timestamp: new Date(Date.now() - 7200000) // 2ì‹œê°„ ì „
        },
        {
          id: 5,
          type: 'user_approved',
          description: 'LGì „ìê°€ ê´€ë¦¬ìì— ì˜í•´ ìŠ¹ì¸ë¨',
          timestamp: new Date(Date.now() - 86400000) // 1ì¼ ì „
        }
      ]
    }
  } catch (error) {
    console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error)
    
    // ì—ëŸ¬ ì‹œ ëª© ë°ì´í„°
    stats.value = {
      totalOrders: 0,
      todayOrders: 0,
      specialCases: 0
    }
    warehouse.value = {
      totalInWarehouse: 0,
      arrivedCount: 0
    }
  } finally {
    loading.value = false
  }
}

// ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
const navigateToOrders = () => {
  router.push('/admin/orders')
}

const navigateToWarehouse = () => {
  window.open('/warehouse-scan.html', '_blank')
}

const navigateToUserApproval = () => {
  alert('ì‚¬ìš©ì ìŠ¹ì¸ í˜ì´ì§€ë¡œ ì´ë™ ì˜ˆì •')
}

const navigateToReports = () => {
  alert('ë¦¬í¬íŠ¸ í˜ì´ì§€ë¡œ ì´ë™ ì˜ˆì •')
}

onMounted(() => {
  loadDashboardData()
  
  // ì‹¤ì‹œê°„ ì‹œê°„ ì—…ë°ì´íŠ¸
  setInterval(() => {
    currentTime.value = new Date().toLocaleString('ko-KR')
  }, 1000)
})
</script>