<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>창고 스캔 시스템 - YCS LMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .scan-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #qr-reader {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid #ef4444;
            width: 200px;
            height: 200px;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .scan-result {
            transition: all 0.3s ease;
        }
        
        .scan-success {
            background: linear-gradient(135deg, rgb(34 197 94) 0%, rgb(22 163 74) 100%);
            color: white;
        }
        
        .scan-error {
            background: linear-gradient(135deg, rgb(239 68 68) 0%, rgb(220 38 38) 100%);
            color: white;
        }
        
        .operator-info {
            background: linear-gradient(135deg, rgb(59 130 246) 0%, rgb(37 99 235) 100%);
            color: white;
        }
        
        .scan-history-item {
            transition: all 0.2s ease;
        }
        
        .scan-history-item:hover {
            background: rgb(249 250 251);
            transform: translateX(4px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- 헤더 -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-4xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">창고 스캔 시스템</h1>
                        <p class="text-sm text-gray-600">QR/바코드 스캔으로 입고/출고 처리</p>
                    </div>
                    <div class="operator-info px-4 py-2 rounded-lg">
                        <div class="text-xs font-medium opacity-80">작업자</div>
                        <div id="operatorName" class="font-semibold">관리자</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-4xl mx-auto px-4 py-6 space-y-6">
            <!-- 스캔 타입 선택 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">작업 유형 선택</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button onclick="setScanType('INBOUND')" 
                            class="scan-type-btn py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-medium text-sm transition-all"
                            id="btn-INBOUND">
                        📦 입고
                    </button>
                    <button onclick="setScanType('OUTBOUND')" 
                            class="scan-type-btn py-3 px-4 rounded-lg border-2 border-gray-200 text-gray-700 font-medium text-sm transition-all"
                            id="btn-OUTBOUND">
                        🚚 출고
                    </button>
                    <button onclick="setScanType('HOLD')" 
                            class="scan-type-btn py-3 px-4 rounded-lg border-2 border-gray-200 text-gray-700 font-medium text-sm transition-all"
                            id="btn-HOLD">
                        ⏸️ 보류
                    </button>
                    <button onclick="setScanType('INVENTORY')" 
                            class="scan-type-btn py-3 px-4 rounded-lg border-2 border-gray-200 text-gray-700 font-medium text-sm transition-all"
                            id="btn-INVENTORY">
                        📋 재고확인
                    </button>
                </div>
                <div class="mt-3 text-sm text-gray-500">
                    현재 선택: <span id="currentScanType" class="font-medium text-blue-600">입고</span>
                </div>
            </div>

            <!-- QR 스캐너 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">QR/바코드 스캔</h2>
                    <div class="flex gap-2">
                        <button onclick="startScanning()" id="startScanBtn"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                            📷 스캔 시작
                        </button>
                        <button onclick="stopScanning()" id="stopScanBtn" style="display: none;"
                                class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">
                            ⏹️ 스캔 정지
                        </button>
                    </div>
                </div>
                
                <!-- 카메라 뷰 -->
                <div class="scan-container">
                    <div id="qr-reader" style="display: none;"></div>
                    <div class="scan-overlay" id="scanOverlay" style="display: none;"></div>
                </div>
                
                <!-- 수동 입력 -->
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        또는 수동으로 입력하세요
                    </label>
                    <div class="flex gap-2">
                        <input type="text" id="manualInput" 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="주문번호 또는 바코드를 입력하세요">
                        <button onclick="processManualInput()" 
                                class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 transition-colors">
                            ✅ 처리
                        </button>
                    </div>
                </div>
            </div>

            <!-- 스캔 결과 -->
            <div id="scanResultSection" class="bg-white rounded-lg shadow-sm p-6" style="display: none;">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">스캔 결과</h2>
                <div id="scanResult" class="scan-result p-4 rounded-lg"></div>
            </div>

            <!-- 추가 정보 입력 -->
            <div id="additionalInfoSection" class="bg-white rounded-lg shadow-sm p-6" style="display: none;">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">추가 정보</h2>
                <div class="space-y-4">
                    <div id="locationInput" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">창고 위치</label>
                        <input type="text" id="location" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="예: A-01-03">
                    </div>
                    <div id="trackingInput" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">운송장 번호</label>
                        <input type="text" id="trackingNumber" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="예: EE123456789KR">
                    </div>
                    <div id="reasonInput" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">보류 사유</label>
                        <select id="holdReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">사유를 선택하세요</option>
                            <option value="손상">포장 손상</option>
                            <option value="불완전">불완전한 패키지</option>
                            <option value="주소불명">수취인 주소 불명확</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">메모</label>
                        <textarea id="notes" rows="2" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  placeholder="추가 메모사항을 입력하세요"></textarea>
                    </div>
                </div>
            </div>

            <!-- 스캔 히스토리 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">스캔 기록</h2>
                    <button onclick="clearHistory()" 
                            class="text-sm text-gray-500 hover:text-red-500 transition-colors">
                        기록 삭제
                    </button>
                </div>
                <div id="scanHistory" class="space-y-2">
                    <div class="text-sm text-gray-500 text-center py-4">
                        아직 스캔 기록이 없습니다.
                    </div>
                </div>
            </div>

            <!-- 일괄 처리 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">일괄 처리</h2>
                <div class="flex gap-2 mb-4">
                    <button onclick="processBatch('INBOUND')" 
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                        일괄 입고
                    </button>
                    <button onclick="processBatch('OUTBOUND')" 
                            class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 transition-colors">
                        일괄 출고
                    </button>
                </div>
                <div class="text-sm text-gray-600">
                    스캔한 항목들을 일괄로 처리할 수 있습니다. 현재 대기 중인 항목: <span id="pendingCount" class="font-medium">0</span>개
                </div>
            </div>
        </div>
    </div>

    <script>
        let html5QrcodeScanner = null;
        let currentScanType = 'INBOUND';
        let scanHistory = [];
        let pendingScanCodes = [];

        // 스캔 타입 설정
        function setScanType(type) {
            currentScanType = type;
            
            // 버튼 스타일 업데이트
            document.querySelectorAll('.scan-type-btn').forEach(btn => {
                btn.className = 'scan-type-btn py-3 px-4 rounded-lg border-2 border-gray-200 text-gray-700 font-medium text-sm transition-all';
            });
            
            document.getElementById(`btn-${type}`).className = 'scan-type-btn py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-medium text-sm transition-all';
            
            // 현재 타입 표시 업데이트
            const typeNames = {
                'INBOUND': '입고',
                'OUTBOUND': '출고',
                'HOLD': '보류',
                'INVENTORY': '재고확인'
            };
            document.getElementById('currentScanType').textContent = typeNames[type];
            
            // 추가 정보 섹션 표시/숨기기
            showAdditionalInfoForType(type);
        }

        function showAdditionalInfoForType(type) {
            const section = document.getElementById('additionalInfoSection');
            const locationInput = document.getElementById('locationInput');
            const trackingInput = document.getElementById('trackingInput');
            const reasonInput = document.getElementById('reasonInput');
            
            // 모든 입력 필드 숨기기
            locationInput.style.display = 'none';
            trackingInput.style.display = 'none';
            reasonInput.style.display = 'none';
            
            // 타입별 필요한 필드 표시
            switch(type) {
                case 'INBOUND':
                    section.style.display = 'block';
                    locationInput.style.display = 'block';
                    break;
                case 'OUTBOUND':
                    section.style.display = 'block';
                    trackingInput.style.display = 'block';
                    break;
                case 'HOLD':
                    section.style.display = 'block';
                    reasonInput.style.display = 'block';
                    break;
                case 'INVENTORY':
                    section.style.display = 'block';
                    break;
                default:
                    section.style.display = 'none';
            }
        }

        // QR 스캔 시작
        function startScanning() {
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
            
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const cameraId = devices[0].id;
                    
                    html5QrcodeScanner.start(
                        cameraId, 
                        config, 
                        onScanSuccess, 
                        onScanFailure
                    ).catch(err => {
                        console.error('카메라 시작 실패:', err);
                        showScanResult(false, '카메라를 시작할 수 없습니다: ' + err);
                    });
                    
                    document.getElementById('qr-reader').style.display = 'block';
                    document.getElementById('scanOverlay').style.display = 'block';
                    document.getElementById('startScanBtn').style.display = 'none';
                    document.getElementById('stopScanBtn').style.display = 'inline-block';
                }
            }).catch(err => {
                console.error('카메라 접근 실패:', err);
                showScanResult(false, '카메라에 접근할 수 없습니다: ' + err);
            });
        }

        // QR 스캔 정지
        function stopScanning() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('qr-reader').style.display = 'none';
                    document.getElementById('scanOverlay').style.display = 'none';
                    document.getElementById('startScanBtn').style.display = 'inline-block';
                    document.getElementById('stopScanBtn').style.display = 'none';
                }).catch(err => {
                    console.error('스캔 정지 실패:', err);
                });
            }
        }

        // 스캔 성공 콜백
        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR 스캔 성공:', decodedText);
            stopScanning();
            processScan(decodedText);
        }

        // 스캔 실패 콜백
        function onScanFailure(error) {
            // 스캔 실패는 일반적인 상황이므로 로그만 남김
            // console.log('스캔 대기 중...', error);
        }

        // 수동 입력 처리
        function processManualInput() {
            const input = document.getElementById('manualInput');
            const code = input.value.trim();
            
            if (!code) {
                showScanResult(false, '코드를 입력해주세요.');
                return;
            }
            
            processScan(code);
            input.value = '';
        }

        // 스캔 처리 메인 함수
        function processScan(scanCode) {
            console.log('스캔 처리 시작:', scanCode, currentScanType);
            
            const requestData = {
                labelCode: scanCode,
                scanType: currentScanType,
                location: document.getElementById('location').value || 'AUTO',
                notes: document.getElementById('notes').value || ''
            };

            // 타입별 추가 데이터
            if (currentScanType === 'OUTBOUND') {
                requestData.trackingNumber = document.getElementById('trackingNumber').value || 'AUTO-' + Date.now();
            } else if (currentScanType === 'HOLD') {
                const reason = document.getElementById('holdReason').value;
                if (!reason) {
                    showScanResult(false, '보류 사유를 선택해주세요.');
                    return;
                }
                requestData.reason = reason;
            }

            // API 호출
            fetch('http://localhost:8081/api/warehouse/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('API 응답:', data);
                if (data.success) {
                    showScanResult(true, data.message, data);
                    addToHistory(scanCode, currentScanType, data.message, true);
                    
                    // 일괄 처리용 목록에 추가
                    if (currentScanType === 'INBOUND' || currentScanType === 'OUTBOUND') {
                        pendingScanCodes.push(scanCode);
                        updatePendingCount();
                    }
                } else {
                    showScanResult(false, data.error || '처리 실패');
                    addToHistory(scanCode, currentScanType, data.error || '처리 실패', false);
                }
            })
            .catch(error => {
                console.error('API 호출 실패:', error);
                showScanResult(false, '서버 연결 실패: ' + error.message);
                addToHistory(scanCode, currentScanType, '서버 연결 실패', false);
            });
        }

        // 스캔 결과 표시
        function showScanResult(success, message, data = null) {
            const section = document.getElementById('scanResultSection');
            const result = document.getElementById('scanResult');
            
            section.style.display = 'block';
            
            if (success) {
                result.className = 'scan-result scan-success p-4 rounded-lg';
                result.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">✅</span>
                        <span class="font-semibold">처리 성공</span>
                    </div>
                    <div class="text-sm opacity-90">${message}</div>
                    ${data && data.order ? `
                        <div class="mt-3 p-3 bg-white/20 rounded text-xs">
                            <div>주문번호: ${data.order.orderNumber}</div>
                            <div>상태: ${data.order.status}</div>
                            ${data.location ? `<div>위치: ${data.location}</div>` : ''}
                        </div>
                    ` : ''}
                `;
            } else {
                result.className = 'scan-result scan-error p-4 rounded-lg';
                result.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">❌</span>
                        <span class="font-semibold">처리 실패</span>
                    </div>
                    <div class="text-sm opacity-90">${message}</div>
                `;
            }
            
            // 3초 후 자동 숨김
            setTimeout(() => {
                section.style.display = 'none';
            }, 3000);
        }

        // 히스토리에 추가
        function addToHistory(scanCode, scanType, message, success) {
            const timestamp = new Date().toLocaleString('ko-KR');
            scanHistory.unshift({
                scanCode,
                scanType,
                message,
                success,
                timestamp
            });
            
            // 최대 10개까지만 유지
            if (scanHistory.length > 10) {
                scanHistory = scanHistory.slice(0, 10);
            }
            
            renderHistory();
        }

        // 히스토리 렌더링
        function renderHistory() {
            const container = document.getElementById('scanHistory');
            
            if (scanHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        아직 스캔 기록이 없습니다.
                    </div>
                `;
                return;
            }
            
            const typeNames = {
                'INBOUND': '입고',
                'OUTBOUND': '출고', 
                'HOLD': '보류',
                'INVENTORY': '재고확인'
            };
            
            container.innerHTML = scanHistory.map(item => `
                <div class="scan-history-item p-3 border border-gray-200 rounded-lg ${item.success ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-red-500'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="${item.success ? 'text-green-600' : 'text-red-600'}">${item.success ? '✅' : '❌'}</span>
                                <span class="font-medium text-sm">${item.scanCode}</span>
                                <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">${typeNames[item.scanType] || item.scanType}</span>
                            </div>
                            <div class="text-sm text-gray-600">${item.message}</div>
                        </div>
                        <div class="text-xs text-gray-400 ml-4">${item.timestamp}</div>
                    </div>
                </div>
            `).join('');
        }

        // 히스토리 삭제
        function clearHistory() {
            if (confirm('스캔 기록을 모두 삭제하시겠습니까?')) {
                scanHistory = [];
                renderHistory();
            }
        }

        // 일괄 처리
        function processBatch(batchType) {
            if (pendingScanCodes.length === 0) {
                showScanResult(false, '일괄 처리할 항목이 없습니다.');
                return;
            }
            
            if (!confirm(`${pendingScanCodes.length}개 항목을 일괄 ${batchType === 'INBOUND' ? '입고' : '출고'} 처리하시겠습니까?`)) {
                return;
            }
            
            const endpoint = batchType === 'INBOUND' ? 'batch/inbound' : 'batch/outbound';
            
            fetch(`http://localhost:8081/api/warehouse/${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    scanCodes: pendingScanCodes,
                    operatorId: 'warehouse-operator'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showScanResult(true, `일괄 처리 완료: 성공 ${data.successCount}개, 실패 ${data.failureCount}개`);
                    pendingScanCodes = [];
                    updatePendingCount();
                } else {
                    showScanResult(false, data.error || '일괄 처리 실패');
                }
            })
            .catch(error => {
                console.error('일괄 처리 실패:', error);
                showScanResult(false, '일괄 처리 중 오류가 발생했습니다.');
            });
        }

        // 대기 중인 항목 수 업데이트
        function updatePendingCount() {
            document.getElementById('pendingCount').textContent = pendingScanCodes.length;
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            setScanType('INBOUND');
            
            // Enter 키로 수동 입력 처리
            document.getElementById('manualInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processManualInput();
                }
            });
        });
    </script>
</body>
</html>