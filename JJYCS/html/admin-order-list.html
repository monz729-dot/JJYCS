<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>어드민 주문 목록 - YCS LMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-pending { @apply bg-yellow-100 text-yellow-800; }
        .status-processing { @apply bg-blue-100 text-blue-800; }
        .status-shipped { @apply bg-green-100 text-green-800; }
        .status-delivered { @apply bg-gray-100 text-gray-800; }
        .status-cancelled { @apply bg-red-100 text-red-800; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h1 class="text-xl font-semibold text-gray-900">주문 관리</h1>
                <p class="text-sm text-gray-600">전체 주문을 확인하고 상태를 관리할 수 있습니다.</p>
            </div>

            <!-- 필터 -->
            <div class="px-6 py-4 bg-gray-50 border-b">
                <div class="flex gap-4">
                    <select id="statusFilter" class="border rounded px-3 py-2">
                        <option value="">전체 상태</option>
                        <option value="RECEIVED">접수</option>
                        <option value="PROCESSING">처리중</option>
                        <option value="SHIPPED">배송중</option>
                        <option value="DELIVERED">배송완료</option>
                        <option value="CANCELLED">취소</option>
                    </select>
                    <button onclick="loadOrders()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        조회
                    </button>
                </div>
            </div>

            <!-- 주문 목록 -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">주문번호</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">고객명</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">수취인</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">CBM</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">배송타입</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">생성일</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">작업</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTable" class="bg-white divide-y divide-gray-200">
                        <!-- 동적으로 생성될 주문 목록 -->
                    </tbody>
                </table>
            </div>

            <!-- 일괄 처리 -->
            <div class="px-6 py-4 bg-gray-50 border-t">
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-700">선택된 주문:</span>
                    <span id="selectedCount" class="text-sm font-medium text-blue-600">0개</span>
                    <div class="flex gap-2 ml-4">
                        <select id="bulkStatus" class="border rounded px-3 py-2">
                            <option value="">상태 선택</option>
                            <option value="PROCESSING">처리중으로 변경</option>
                            <option value="SHIPPED">배송중으로 변경</option>
                            <option value="DELIVERED">배송완료로 변경</option>
                        </select>
                        <button onclick="bulkUpdateStatus()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            일괄 변경
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 상태 변경 모달 -->
    <div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">주문 상태 변경</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">새 상태</label>
                <select id="newStatus" class="w-full border rounded px-3 py-2">
                    <option value="RECEIVED">접수</option>
                    <option value="PROCESSING">처리중</option>
                    <option value="SHIPPED">배송중</option>
                    <option value="DELIVERED">배송완료</option>
                    <option value="CANCELLED">취소</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">변경 사유</label>
                <textarea id="changeReason" class="w-full border rounded px-3 py-2" rows="3" placeholder="상태 변경 사유를 입력하세요"></textarea>
            </div>
            <div class="flex gap-3">
                <button onclick="closeStatusModal()" class="flex-1 border rounded px-4 py-2 hover:bg-gray-50">
                    취소
                </button>
                <button onclick="confirmStatusChange()" class="flex-1 bg-blue-500 text-white rounded px-4 py-2 hover:bg-blue-600">
                    변경
                </button>
            </div>
        </div>
    </div>

    <script>
        let orders = [];
        let selectedOrders = [];
        let currentOrderId = null;

        // 페이지 로드 시 주문 목록 조회
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
        });

        // 주문 목록 조회
        async function loadOrders() {
            try {
                const response = await fetch('/api/orders', {
                    headers: {
                        'Authorization': 'Bearer mock-jwt-token'
                    }
                });

                if (!response.ok) {
                    throw new Error('주문 조회 실패');
                }

                const data = await response.json();
                orders = data.orders || [];
                renderOrders();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                alert('주문 목록을 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 주문 목록 렌더링
        function renderOrders() {
            const tbody = document.getElementById('ordersTable');
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredOrders = orders;
            if (statusFilter) {
                filteredOrders = orders.filter(order => order.status === statusFilter);
            }

            tbody.innerHTML = filteredOrders.map(order => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <input type="checkbox" value="${order.id}" onchange="toggleOrderSelection(${order.id})">
                    </td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${order.orderNumber}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${order.user?.name || '미상'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${order.recipientName}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full status-${order.status.toLowerCase()}">
                            ${getStatusText(order.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${order.totalCbm || 0} m³</td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${order.shippingType === 'SEA' ? '해상' : '항공'}
                        ${order.totalCbm > 29 ? '(자동변환)' : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${new Date(order.createdAt).toLocaleDateString('ko-KR')}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <button onclick="openStatusModal(${order.id})" 
                                class="text-blue-600 hover:text-blue-900 mr-3">
                            상태변경
                        </button>
                        <button onclick="viewOrderDetail(${order.id})" 
                                class="text-green-600 hover:text-green-900">
                            상세보기
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 상태 텍스트 변환
        function getStatusText(status) {
            const statusMap = {
                'RECEIVED': '접수',
                'PROCESSING': '처리중',  
                'SHIPPED': '배송중',
                'DELIVERED': '배송완료',
                'CANCELLED': '취소',
                'PENDING': '대기',
                'ARRIVED': '도착',
                'IN_TRANSIT': '운송중',
                'BILLING': '청구',
                'PAYMENT_PENDING': '결제대기',
                'DELAYED': '지연',
                'SHIPPING': '배송준비'
            };
            return statusMap[status] || status;
        }

        // 전체 선택 토글
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const orderId = parseInt(checkbox.value);
                if (selectAll.checked) {
                    if (!selectedOrders.includes(orderId)) {
                        selectedOrders.push(orderId);
                    }
                } else {
                    selectedOrders = selectedOrders.filter(id => id !== orderId);
                }
            });
            
            updateSelectedCount();
        }

        // 개별 주문 선택 토글
        function toggleOrderSelection(orderId) {
            const checkbox = document.querySelector(`input[value="${orderId}"]`);
            if (checkbox.checked) {
                if (!selectedOrders.includes(orderId)) {
                    selectedOrders.push(orderId);
                }
            } else {
                selectedOrders = selectedOrders.filter(id => id !== orderId);
            }
            updateSelectedCount();
        }

        // 선택된 주문 수 업데이트
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedOrders.length + '개';
        }

        // 상태 변경 모달 열기
        function openStatusModal(orderId) {
            currentOrderId = orderId;
            const order = orders.find(o => o.id === orderId);
            if (order) {
                document.getElementById('newStatus').value = order.status;
                document.getElementById('statusModal').classList.remove('hidden');
            }
        }

        // 상태 변경 모달 닫기
        function closeStatusModal() {
            document.getElementById('statusModal').classList.add('hidden');
            currentOrderId = null;
            document.getElementById('changeReason').value = '';
        }

        // 상태 변경 확인
        async function confirmStatusChange() {
            if (!currentOrderId) return;

            const newStatus = document.getElementById('newStatus').value;
            const reason = document.getElementById('changeReason').value;

            try {
                const response = await fetch(`/api/orders/${currentOrderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer mock-jwt-token'
                    },
                    body: JSON.stringify({
                        status: newStatus,
                        reason: reason
                    })
                });

                if (response.ok) {
                    alert('주문 상태가 변경되었습니다.');
                    closeStatusModal();
                    await loadOrders(); // 목록 새로고침
                } else {
                    alert('상태 변경에 실패했습니다.');
                }
            } catch (error) {
                console.error('Status update error:', error);
                alert('상태 변경 중 오류가 발생했습니다.');
            }
        }

        // 일괄 상태 변경
        async function bulkUpdateStatus() {
            if (selectedOrders.length === 0) {
                alert('변경할 주문을 선택하세요.');
                return;
            }

            const bulkStatus = document.getElementById('bulkStatus').value;
            if (!bulkStatus) {
                alert('변경할 상태를 선택하세요.');
                return;
            }

            try {
                const promises = selectedOrders.map(orderId => 
                    fetch(`/api/orders/${orderId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer mock-jwt-token'
                        },
                        body: JSON.stringify({
                            status: bulkStatus,
                            reason: '일괄 처리'
                        })
                    })
                );

                await Promise.all(promises);
                alert(`${selectedOrders.length}개 주문의 상태가 변경되었습니다.`);
                
                selectedOrders = [];
                document.getElementById('selectAll').checked = false;
                updateSelectedCount();
                await loadOrders();

            } catch (error) {
                console.error('Bulk update error:', error);
                alert('일괄 변경 중 오류가 발생했습니다.');
            }
        }

        // 주문 상세보기
        function viewOrderDetail(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                const details = `
주문번호: ${order.orderNumber}
고객명: ${order.user?.name || '미상'}
수취인: ${order.recipientName}
상태: ${getStatusText(order.status)}
배송타입: ${order.shippingType === 'SEA' ? '해상' : '항공'}
총 CBM: ${order.totalCbm || 0} m³
총 중량: ${order.totalWeight || 0} kg
특별요청: ${order.specialRequests || '없음'}
생성일: ${new Date(order.createdAt).toLocaleString('ko-KR')}
                `;
                alert(details);
            }
        }
    </script>
</body>
</html>