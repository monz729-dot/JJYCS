<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>파트너 업무 관리 - YSC 물류관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <style>
        .bg-gradient-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .shadow-blue {
            box-shadow: 0 4px 14px -2px rgba(59, 130, 246, 0.15);
        }

        .task-card {
            transition: all 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -2px rgba(59, 130, 246, 0.25);
        }

        .tab-button {
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: white;
            color: #1d4ed8;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .tab-button:not(.active) {
            color: #2563eb;
        }

        .tab-button:not(.active):hover {
            background: rgba(255, 255, 255, 0.5);
            color: #1d4ed8;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #d97706;
            border-color: #fbbf24;
        }

        .status-inprogress {
            background-color: #dbeafe;
            color: #2563eb;
            border-color: #60a5fa;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #059669;
            border-color: #34d399;
        }

        .priority-high {
            background-color: #fee2e2;
            color: #dc2626;
            border-color: #f87171;
        }

        .priority-medium {
            background-color: #fef3c7;
            color: #d97706;
            border-color: #fbbf24;
        }

        .priority-low {
            background-color: #d1fae5;
            color: #059669;
            border-color: #34d399;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 0.5rem;
            max-width: 28rem;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .route-text {
            background: linear-gradient(90deg, #2563eb, #7c3aed);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .scroll-container {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .scroll-container::-webkit-scrollbar {
            display: none;
        }

        @media (max-width: 640px) {
            .modal-content {
                width: 95%;
                margin: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 메인 컨테이너 -->
    <div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100 pb-20">
        <!-- 헤더 -->
        <header class="bg-white border-b border-blue-100 shadow-sm sticky top-0 z-40">
            <div class="px-4 py-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-xl font-semibold text-blue-900">파트너 업무 관리</h1>
                        <p class="text-sm text-blue-600"><span id="partnerCompany">파트너 회사명</span> - 창고 및 청구서 업무</p>
                    </div>
                    <div class="w-12 h-12 bg-gradient-primary rounded-full flex items-center justify-center shadow-blue">
                        <i data-lucide="package" class="h-6 w-6 text-white"></i>
                    </div>
                </div>

                <!-- 검색 -->
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-blue-600/60"></i>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="주문번호, 고객명, 송장번호로 검색..."
                        class="w-full pl-10 h-12 border border-blue-200 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-200 bg-blue-50/30 hover:bg-blue-50/50 focus:bg-white transition-all duration-300"
                        oninput="filterTasks()"
                    />
                </div>
            </div>
        </header>

        <div class="p-4">
            <!-- 탭 네비게이션 -->
            <div class="flex space-x-1 mb-6 bg-blue-50/50 p-1 rounded-lg overflow-x-auto scroll-container">
                <button 
                    id="arrivalTab" 
                    class="tab-button flex-shrink-0 py-3 px-4 rounded-md active" 
                    onclick="selectTab('arrival')"
                >
                    <div class="flex items-center justify-center gap-2">
                        <i data-lucide="package" class="h-4 w-4"></i>
                        <span class="font-medium">창고도착</span>
                        <span id="arrivalCount" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border border-gray-300 bg-white text-gray-700">0</span>
                    </div>
                </button>
                <button 
                    id="repackingTab" 
                    class="tab-button flex-shrink-0 py-3 px-4 rounded-md" 
                    onclick="selectTab('repacking')"
                >
                    <div class="flex items-center justify-center gap-2">
                        <i data-lucide="wrench" class="h-4 w-4"></i>
                        <span class="font-medium">리패킹</span>
                        <span id="repackingCount" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border border-gray-300 bg-white text-gray-700">0</span>
                    </div>
                </button>
                <button 
                    id="billingTab" 
                    class="tab-button flex-shrink-0 py-3 px-4 rounded-md" 
                    onclick="selectTab('billing')"
                >
                    <div class="flex items-center justify-center gap-2">
                        <i data-lucide="file-text" class="h-4 w-4"></i>
                        <span class="font-medium">청구서발행</span>
                        <span id="billingCount" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border border-gray-300 bg-white text-gray-700">0</span>
                    </div>
                </button>
                <button 
                    id="completedTab" 
                    class="tab-button flex-shrink-0 py-3 px-4 rounded-md" 
                    onclick="selectTab('completed')"
                >
                    <div class="flex items-center justify-center gap-2">
                        <i data-lucide="check-circle" class="h-4 w-4"></i>
                        <span class="font-medium">완료</span>
                        <span id="completedCount" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border border-gray-300 bg-white text-gray-700">0</span>
                    </div>
                </button>
            </div>

            <!-- 작업 목록 -->
            <div id="tasksList" class="space-y-4">
                <!-- 작업 목록이 여기에 동적으로 추가됩니다 -->
            </div>

            <!-- 빈 목록 메시지 -->
            <div id="emptyMessage" class="task-card bg-white rounded-lg shadow-blue border-blue-100 border hidden">
                <div class="flex flex-col items-center justify-center py-12">
                    <i data-lucide="package" class="h-12 w-12 text-blue-300 mb-4"></i>
                    <h3 class="text-lg font-medium text-blue-900 mb-2">작업이 없습니다</h3>
                    <p id="emptyDescription" class="text-blue-600 text-center">현재 해당 단계의 작업이 없습니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 창고 도착 확인 모달 -->
    <div id="arrivalModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">창고 도착 확인</h2>
                    <p class="text-sm text-gray-600" id="arrivalModalDescription">실제 무게를 측정하고 상품 상태를 확인해주세요.</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium mb-2 block">실제 무게 (kg) *</label>
                        <input
                            type="number"
                            id="actualWeight"
                            step="0.1"
                            placeholder="예: 2.5"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">상품 상태 메모</label>
                        <textarea
                            id="arrivalNotes"
                            placeholder="상품 상태, 포장 상태 등을 기록해주세요..."
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                    </div>
                    <div class="flex gap-2 pt-4">
                        <button class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" onclick="closeModal('arrivalModal')">
                            취소
                        </button>
                        <button class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="confirmArrival()">
                            확인 완료
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 리패킹 완료 모달 -->
    <div id="repackingModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">리패킹 작업 완료</h2>
                    <p class="text-sm text-gray-600" id="repackingModalDescription">리패킹 작업을 완료하고 사진을 업로드해주세요.</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium mb-2 block">업로드할 사진 수 *</label>
                        <input
                            type="number"
                            id="photoCount"
                            min="1"
                            placeholder="예: 3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                        <p class="text-xs text-gray-500 mt-1">리패킹 전후 사진을 업로드해주세요</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">리패킹 내용</label>
                        <textarea
                            id="repackingNotes"
                            placeholder="분할 포장 내용, 특이사항 등을 기록해주세요..."
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                    </div>
                    <div class="flex gap-2 pt-4">
                        <button class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" onclick="closeModal('repackingModal')">
                            취소
                        </button>
                        <button class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700" onclick="completeRepacking()">
                            작업 완료
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 청구서 발행 모달 -->
    <div id="billingModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">청구서 발행</h2>
                    <p class="text-sm text-gray-600" id="billingModalDescription">최종 비용을 산정하여 청구서를 발행합니다.</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium mb-2 block">기본 배송비 (THB) *</label>
                        <input
                            type="number"
                            id="shippingFee"
                            placeholder="예: 85000"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">현지 배송비 (THB)</label>
                        <input
                            type="number"
                            id="localFee"
                            placeholder="예: 25000"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div id="repackingFeeSection" class="hidden">
                        <label class="text-sm font-medium mb-2 block">리패킹 비용 (THB)</label>
                        <input
                            type="number"
                            id="repackingFee"
                            placeholder="예: 15000"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-800">
                            * TAX 7%가 자동으로 계산되어 최종 금액에 포함됩니다.
                        </p>
                    </div>
                    <div class="flex gap-2 pt-4">
                        <button class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" onclick="closeModal('billingModal')">
                            취소
                        </button>
                        <button class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" onclick="createBilling()">
                            청구서 발행
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentTab = 'arrival';
        let searchQuery = '';
        let selectedTaskId = null;

        // 데모 데이터
        const tasks = [
            {
                id: 'TASK-2024-001',
                type: 'warehouse_arrival',
                status: 'pending',
                priority: 'high',
                orderNumber: 'YCS-240115-001',
                customerName: '김철수',
                customerPhone: '010-1234-5678',
                trackingNumber: 'EE123456789KR',
                expectedWeight: 2.0,
                items: [
                    { name: '빼빼로 초콜릿', quantity: 10, weight: 1.5, cbm: 0.003 },
                    { name: '초콜릿 과자', quantity: 5, weight: 0.5, cbm: 0.001 }
                ],
                destination: '태국 방콕',
                shippingType: 'sea',
                repackingRequested: true,
                repackingCompleted: false,
                photosUploaded: []
            },
            {
                id: 'TASK-2024-002',
                type: 'repacking',
                status: 'inprogress',
                priority: 'medium',
                orderNumber: 'YCS-240114-002',
                customerName: '이영희',
                customerPhone: '010-9876-5432',
                trackingNumber: 'EE987654321KR',
                expectedWeight: 3.0,
                actualWeight: 3.2,
                items: [
                    { name: '전자제품', quantity: 2, weight: 2.0, cbm: 0.032 },
                    { name: '액세서리', quantity: 5, weight: 1.2, cbm: 0.008 }
                ],
                destination: '태국 치앙마이',
                shippingType: 'air',
                repackingRequested: true,
                repackingCompleted: false,
                photosUploaded: ['arrival_240114.jpg'],
                arrivalDate: '2024-01-14',
                notes: '전자제품 포장 상태 양호'
            },
            {
                id: 'TASK-2024-003',
                type: 'billing',
                status: 'pending',
                priority: 'high',
                orderNumber: 'YCS-240113-003',
                customerName: '박민수',
                customerPhone: '010-5555-6666',
                trackingNumber: 'EE456789123KR',
                expectedWeight: 1.5,
                actualWeight: 1.8,
                items: [
                    { name: '건강식품', quantity: 1, weight: 1.8, cbm: 0.012 }
                ],
                destination: '태국 파타야',
                shippingType: 'sea',
                repackingRequested: false,
                repackingCompleted: false,
                photosUploaded: ['arrival_240113.jpg'],
                arrivalDate: '2024-01-13',
                notes: '무게 차이 있음, 재계량 완료'
            },
            {
                id: 'TASK-2024-004',
                type: 'warehouse_arrival',
                status: 'completed',
                priority: 'low',
                orderNumber: 'YCS-240112-004',
                customerName: '최지현',
                customerPhone: '010-7777-8888',
                trackingNumber: 'EE789123456KR',
                expectedWeight: 2.5,
                actualWeight: 2.5,
                items: [
                    { name: '의류', quantity: 8, weight: 2.5, cbm: 0.025 }
                ],
                destination: '태국 푸켓',
                shippingType: 'sea',
                repackingRequested: true,
                repackingCompleted: true,
                photosUploaded: ['arrival_240112.jpg', 'repacking_240112_1.jpg', 'repacking_240112_2.jpg'],
                arrivalDate: '2024-01-12',
                notes: '리패킹 완료, 4개씩 2개 포장으로 분할',
                billing: {
                    proformaIssued: true,
                    finalIssued: false,
                    shippingFee: 75000,
                    localDeliveryFee: 20000,
                    total: 105700
                }
            }
        ];

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            loadUserData();
            updateTabCounts();
            renderTasks();
        });

        // 사용자 데이터 로드
        function loadUserData() {
            document.getElementById('partnerCompany').textContent = '파트너 회사명';
        }

        // 탭 선택
        function selectTab(tab) {
            currentTab = tab;
            
            // 모든 탭에서 active 클래스 제거
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 선택된 탭에 active 클래스 추가
            document.getElementById(tab + 'Tab').classList.add('active');
            
            renderTasks();
        }

        // 탭별 카운트 업데이트
        function updateTabCounts() {
            const arrivalCount = tasks.filter(t => t.type === 'warehouse_arrival' && t.status !== 'completed').length;
            const repackingCount = tasks.filter(t => 
                (t.type === 'repacking' || (t.arrivalDate && t.repackingRequested)) && 
                t.status !== 'completed'
            ).length;
            const billingCount = tasks.filter(t => 
                (t.type === 'billing' || (t.actualWeight && (!t.repackingRequested || t.repackingCompleted))) && 
                t.status !== 'completed'
            ).length;
            const completedCount = tasks.filter(t => t.status === 'completed').length;

            document.getElementById('arrivalCount').textContent = arrivalCount;
            document.getElementById('repackingCount').textContent = repackingCount;
            document.getElementById('billingCount').textContent = billingCount;
            document.getElementById('completedCount').textContent = completedCount;
        }

        // 작업 필터링
        function filterTasks() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase();
            renderTasks();
        }

        // 필터된 작업 목록 가져오기
        function getFilteredTasks() {
            let filtered = tasks;
            
            // 탭 필터
            switch (currentTab) {
                case 'arrival':
                    filtered = filtered.filter(task => task.type === 'warehouse_arrival' && task.status !== 'completed');
                    break;
                case 'repacking':
                    filtered = filtered.filter(task => 
                        (task.type === 'repacking' || (task.arrivalDate && task.repackingRequested)) && 
                        task.status !== 'completed'
                    );
                    break;
                case 'billing':
                    filtered = filtered.filter(task => 
                        (task.type === 'billing' || (task.actualWeight && (!task.repackingRequested || task.repackingCompleted))) && 
                        task.status !== 'completed'
                    );
                    break;
                case 'completed':
                    filtered = filtered.filter(task => task.status === 'completed');
                    break;
            }

            // 검색 필터
            if (searchQuery) {
                filtered = filtered.filter(task => 
                    task.orderNumber.toLowerCase().includes(searchQuery) ||
                    task.customerName.toLowerCase().includes(searchQuery) ||
                    task.trackingNumber.toLowerCase().includes(searchQuery)
                );
            }

            return filtered;
        }

        // 상태 배지 HTML 생성
        function getStatusBadgeHTML(task) {
            const configs = {
                pending: { label: '대기중', className: 'status-pending' },
                inprogress: { label: '진행중', className: 'status-inprogress' },
                completed: { label: '완료', className: 'status-completed' }
            };

            const config = configs[task.status];
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${config.className}">${config.label}</span>`;
        }

        // 우선순위 배지 HTML 생성
        function getPriorityBadgeHTML(priority) {
            const configs = {
                high: { label: '긴급', className: 'priority-high' },
                medium: { label: '보통', className: 'priority-medium' },
                low: { label: '낮음', className: 'priority-low' }
            };

            const config = configs[priority];
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${config.className}">${config.label}</span>`;
        }

        // 작업 타입 아이콘 HTML 생성
        function getTaskTypeIconHTML(type) {
            const icons = {
                warehouse_arrival: 'package',
                repacking: 'wrench',
                billing: 'file-text'
            };

            const colors = {
                warehouse_arrival: 'text-blue-600',
                repacking: 'text-orange-600',
                billing: 'text-purple-600'
            };

            return `<i data-lucide="${icons[type]}" class="h-5 w-5 ${colors[type]}"></i>`;
        }

        // 작업 목록 렌더링
        function renderTasks() {
            const filteredTasks = getFilteredTasks();
            const tasksList = document.getElementById('tasksList');
            const emptyMessage = document.getElementById('emptyMessage');
            const emptyDescription = document.getElementById('emptyDescription');
            
            if (filteredTasks.length === 0) {
                tasksList.innerHTML = '';
                emptyMessage.classList.remove('hidden');
                emptyDescription.textContent = searchQuery ? 
                    '검색 조건에 맞는 작업이 없습니다.' : 
                    '현재 해당 단계의 작업이 없습니다.';
                return;
            }
            
            emptyMessage.classList.add('hidden');
            
            tasksList.innerHTML = filteredTasks.map(task => {
                const totalCBM = task.items.reduce((sum, item) => sum + item.cbm, 0);
                
                return `
                    <div class="task-card bg-white rounded-lg shadow-blue border-blue-100 border">
                        <div class="p-4 pb-2">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="flex items-center gap-2 text-blue-900 font-semibold mb-1">
                                        ${getTaskTypeIconHTML(task.type)}
                                        ${task.orderNumber}
                                    </div>
                                    <p class="text-sm text-gray-600 flex items-center gap-2">
                                        <span>${task.customerName}</span>
                                        <span>•</span>
                                        <span>${task.destination}</span>
                                        <span>•</span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border border-gray-300 bg-white text-gray-700">
                                            ${task.shippingType === 'air' ? '항공' : '해상'}
                                        </span>
                                    </p>
                                </div>
                                <div class="flex flex-col gap-2">
                                    ${getStatusBadgeHTML(task)}
                                    ${getPriorityBadgeHTML(task.priority)}
                                </div>
                            </div>
                        </div>

                        <div class="px-4 pb-4 space-y-4">
                            <!-- 기본 정보 -->
                            <div class="grid grid-cols-2 gap-4 p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="truck" class="h-4 w-4 text-gray-600"></i>
                                    <span class="text-sm font-mono">${task.trackingNumber}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i data-lucide="scale" class="h-4 w-4 text-gray-600"></i>
                                    <span class="text-sm">
                                        예상: ${task.expectedWeight}kg
                                        ${task.actualWeight ? ` → 실제: ${task.actualWeight}kg` : ''}
                                    </span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i data-lucide="phone" class="h-4 w-4 text-gray-600"></i>
                                    <span class="text-sm">${task.customerPhone}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i data-lucide="calculator" class="h-4 w-4 text-gray-600"></i>
                                    <span class="text-sm">
                                        CBM: ${totalCBM.toFixed(3)}m³
                                    </span>
                                </div>
                            </div>

                            <!-- 품목 정보 -->
                            <div class="p-3 bg-blue-50/50 rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="package" class="h-4 w-4 text-blue-600"></i>
                                    <span class="font-medium text-blue-900">품목 정보</span>
                                </div>
                                <div class="space-y-1">
                                    ${task.items.map(item => `
                                        <div class="flex justify-between text-sm text-blue-800">
                                            <span>${item.name} × ${item.quantity}개</span>
                                            <span>${item.weight}kg</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- 진행 상태 -->
                            <div class="grid grid-cols-2 gap-2">
                                <div class="p-2 rounded text-center text-sm ${task.arrivalDate ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                                    창고도착: ${task.arrivalDate ? '완료' : '대기'}
                                </div>
                                ${task.repackingRequested ? `
                                    <div class="p-2 rounded text-center text-sm ${task.repackingCompleted ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                        리패킹: ${task.repackingCompleted ? '완료' : '진행중'}
                                    </div>
                                ` : ''}
                            </div>

                            <!-- 업로드된 사진 -->
                            ${task.photosUploaded.length > 0 ? `
                                <div class="flex items-center gap-2 text-sm text-green-600">
                                    <i data-lucide="camera" class="h-4 w-4"></i>
                                    <span>사진 ${task.photosUploaded.length}장 업로드됨</span>
                                </div>
                            ` : ''}

                            <!-- 청구서 정보 -->
                            ${task.billing ? `
                                <div class="p-3 bg-purple-50 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="file-text" class="h-4 w-4 text-purple-600"></i>
                                            <span class="font-medium text-purple-900">청구서</span>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-medium text-purple-900">${task.billing.total?.toLocaleString()} THB</p>
                                            <div class="flex gap-1">
                                                ${task.billing.proformaIssued ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border border-gray-300 bg-white text-gray-700">Proforma</span>' : ''}
                                                ${task.billing.finalIssued ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border border-gray-300 bg-white text-gray-700">Final</span>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- 메모 -->
                            ${task.notes ? `
                                <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <div class="flex items-start gap-2">
                                        <i data-lucide="alert-circle" class="h-4 w-4 text-yellow-600 mt-0.5"></i>
                                        <div>
                                            <p class="font-medium text-yellow-900 text-sm">메모</p>
                                            <p class="text-sm text-yellow-800">${task.notes}</p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- 작업 버튼들 -->
                            <div class="flex gap-2 pt-2">
                                ${getActionButtonsHTML(task)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 아이콘 다시 생성
            lucide.createIcons();
        }

        // 작업 버튼 HTML 생성
        function getActionButtonsHTML(task) {
            let buttons = [];

            // 창고 도착 확인
            if (task.type === 'warehouse_arrival' && task.status === 'pending') {
                buttons.push(`
                    <button 
                        onclick="openArrivalModal('${task.id}')"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2"
                    >
                        <i data-lucide="package" class="h-4 w-4"></i>
                        창고도착 확인
                    </button>
                `);
            }

            // 리패킹 작업
            if (task.arrivalDate && task.repackingRequested && !task.repackingCompleted) {
                buttons.push(`
                    <button 
                        onclick="openRepackingModal('${task.id}')"
                        class="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2"
                    >
                        <i data-lucide="wrench" class="h-4 w-4"></i>
                        리패킹 완료
                    </button>
                `);
            }

            // 청구서 발행
            if (task.actualWeight && (!task.repackingRequested || task.repackingCompleted) && !task.billing?.proformaIssued) {
                buttons.push(`
                    <button 
                        onclick="openBillingModal('${task.id}')"
                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2"
                    >
                        <i data-lucide="file-text" class="h-4 w-4"></i>
                        청구서 발행
                    </button>
                `);
            }

            // 고객 연락
            buttons.push(`
                <button 
                    onclick="window.open('tel:${task.customerPhone}')"
                    class="border border-blue-300 text-blue-600 hover:bg-blue-50 px-3 py-2 rounded-lg"
                >
                    <i data-lucide="phone" class="h-4 w-4"></i>
                </button>
            `);

            // 상세 보기
            buttons.push(`
                <button 
                    onclick="viewTaskDetail('${task.id}')"
                    class="border border-gray-300 text-gray-600 hover:bg-gray-50 px-3 py-2 rounded-lg"
                >
                    <i data-lucide="eye" class="h-4 w-4"></i>
                </button>
            `);

            return buttons.join('');
        }

        // 모달 관련 함수들
        function openArrivalModal(taskId) {
            selectedTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            document.getElementById('arrivalModalDescription').textContent = 
                `${task.orderNumber} - 실제 무게를 측정하고 상품 상태를 확인해주세요.`;
            document.getElementById('arrivalModal').classList.add('show');
        }

        function openRepackingModal(taskId) {
            selectedTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            document.getElementById('repackingModalDescription').textContent = 
                `${task.orderNumber} - 리패킹 작업을 완료하고 사진을 업로드해주세요.`;
            document.getElementById('repackingModal').classList.add('show');
        }

        function openBillingModal(taskId) {
            selectedTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            document.getElementById('billingModalDescription').textContent = 
                `${task.orderNumber} - 최종 비용을 산정하여 청구서를 발행합니다.`;
            
            // 리패킹 완료된 경우 리패킹 비용 섹션 표시
            if (task.repackingCompleted) {
                document.getElementById('repackingFeeSection').classList.remove('hidden');
            } else {
                document.getElementById('repackingFeeSection').classList.add('hidden');
            }
            
            document.getElementById('billingModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            selectedTaskId = null;
            
            // 입력 필드 초기화
            document.querySelectorAll(`#${modalId} input, #${modalId} textarea`).forEach(input => {
                input.value = '';
            });
        }

        // 작업 처리 함수들
        function confirmArrival() {
            const actualWeight = parseFloat(document.getElementById('actualWeight').value);
            const notes = document.getElementById('arrivalNotes').value;
            
            if (!actualWeight) {
                alert('실제 무게를 입력해주세요.');
                return;
            }

            const task = tasks.find(t => t.id === selectedTaskId);
            alert(`창고 도착 확인: ${task.orderNumber}\n실제 무게: ${actualWeight}kg\n메모: ${notes}`);
            
            closeModal('arrivalModal');
        }

        function completeRepacking() {
            const photoCount = parseInt(document.getElementById('photoCount').value);
            const notes = document.getElementById('repackingNotes').value;
            
            if (!photoCount || photoCount === 0) {
                alert('리패킹 사진을 업로드해주세요.');
                return;
            }

            const task = tasks.find(t => t.id === selectedTaskId);
            alert(`리패킹 완료: ${task.orderNumber}\n사진 수: ${photoCount}장\n메모: ${notes}`);
            
            closeModal('repackingModal');
        }

        function createBilling() {
            const shippingFee = parseFloat(document.getElementById('shippingFee').value);
            const localFee = parseFloat(document.getElementById('localFee').value) || 0;
            const repackingFee = parseFloat(document.getElementById('repackingFee').value) || 0;
            
            if (!shippingFee) {
                alert('배송비를 입력해주세요.');
                return;
            }

            const total = shippingFee + localFee + repackingFee;
            const tax = Math.round(total * 0.07);
            const finalTotal = total + tax;

            const task = tasks.find(t => t.id === selectedTaskId);
            alert(`청구서 발행: ${task.orderNumber}\n총 금액: ${finalTotal.toLocaleString()} THB\n(TAX 7% 포함)`);
            
            closeModal('billingModal');
        }

        function viewTaskDetail(taskId) {
            const task = tasks.find(t => t.id === taskId);
            console.log('Task detail:', task);
            // 실제 구현에서는 상세 페이지로 이동하거나 모달 표시
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }
    </script>
</body>
</html>